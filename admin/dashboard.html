<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة التحكم - فرح</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
      direction: rtl;
    }

    .header {
      background: linear-gradient(135deg, #2D2871 0%, #1f1a5a 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-logout {
      padding: 8px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: rgba(255,255,255,0.3);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-right: 4px solid #2D2871;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .stat-card .value {
      font-size: 36px;
      font-weight: bold;
      color: #2D2871;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      background: white;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    .tab {
      padding: 12px 24px;
      background: #f0f0f0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab.active {
      background: #2D2871;
      color: white;
    }

    .tab:hover:not(.active) {
      background: #e0e0e0;
    }

    .content-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .search-bar {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }

    .search-bar input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #2D2871;
    }

    .search-bar button {
      padding: 12px 24px;
      background: #2D2871;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .search-bar button:hover {
      background: #1f1a5a;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th,
    table td {
      padding: 14px;
      text-align: right;
      border-bottom: 1px solid #eee;
    }

    table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2D2871;
      position: sticky;
      top: 0;
    }

    table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .badge.active {
      background: #d4edda;
      color: #155724;
    }

    .badge.inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .badge.pending {
      background: #fff3cd;
      color: #856404;
    }

    .badge.completed {
      background: #d1ecf1;
      color: #0c5460;
    }

    .badge.customer {
      background: #e7f3ff;
      color: #004085;
    }

    .badge.provider {
      background: #fff4e6;
      color: #856404;
    }

    .badge.admin {
      background: #f3e5f5;
      color: #4a148c;
    }

    .btn {
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin: 0 3px;
      transition: all 0.3s;
    }

    .btn-edit {
      background: #17a2b8;
      color: white;
    }

    .btn-edit:hover {
      background: #138496;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background: #c82333;
    }

    .btn-toggle {
      background: #28a745;
      color: white;
    }

    .btn-toggle:hover {
      background: #218838;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-right: 4px solid #c33;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>لوحة تحكم فرح</h1>
    <div class="header-actions">
      <div class="user-info">
        <span id="userName">-</span>
      </div>
      <button class="btn-logout" onclick="logout()">تسجيل الخروج</button>
    </div>
  </div>

  <div class="container">
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>إجمالي المستخدمين</h3>
        <div class="value" id="totalUsers">-</div>
      </div>
      <div class="stat-card">
        <h3>إجمالي القاعات</h3>
        <div class="value" id="totalVenues">-</div>
      </div>
      <div class="stat-card">
        <h3>إجمالي الخدمات</h3>
        <div class="value" id="totalServices">-</div>
      </div>
      <div class="stat-card">
        <h3>إجمالي الحجوزات</h3>
        <div class="value" id="totalBookings">-</div>
      </div>
      <div class="stat-card">
        <h3>إجمالي الإيرادات</h3>
        <div class="value" id="totalRevenue">-</div>
      </div>
      <div class="stat-card">
        <h3>حجوزات قيد الانتظار</h3>
        <div class="value" id="pendingBookings">-</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('users')">المستخدمين</button>
      <button class="tab" onclick="showTab('venues')">القاعات</button>
      <button class="tab" onclick="showTab('services')">الخدمات</button>
      <button class="tab" onclick="showTab('bookings')">الحجوزات</button>
    </div>

    <div id="usersSection" class="content-section active">
      <div class="search-bar">
        <input type="text" id="userSearch" placeholder="بحث في المستخدمين (الاسم، البريد، الهاتف)...">
        <button onclick="loadUsers()">بحث</button>
      </div>
      <div id="usersTable"></div>
    </div>

    <div id="venuesSection" class="content-section">
      <div class="search-bar">
        <input type="text" id="venueSearch" placeholder="بحث في القاعات...">
        <button onclick="loadVenues()">بحث</button>
      </div>
      <div id="venuesTable"></div>
    </div>

    <div id="servicesSection" class="content-section">
      <div class="search-bar">
        <input type="text" id="serviceSearch" placeholder="بحث في الخدمات...">
        <button onclick="loadServices()">بحث</button>
      </div>
      <div id="servicesTable"></div>
    </div>

    <div id="bookingsSection" class="content-section">
      <div class="search-bar">
        <input type="text" id="bookingSearch" placeholder="بحث في الحجوزات...">
        <button onclick="loadBookings()">بحث</button>
      </div>
      <div id="bookingsTable"></div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.origin.replace(/:\d+$/, ':5000') + '/api';
    
    let currentUser = null;
    let authToken = null;

    // Check authentication
    function checkAuth() {
      authToken = localStorage.getItem('admin_token');
      const userStr = localStorage.getItem('admin_user');
      
      if (!authToken || !userStr) {
        window.location.href = 'login.html';
        return false;
      }

      try {
        currentUser = JSON.parse(userStr);
        if (currentUser.role !== 'ADMIN') {
          alert('ليس لديك صلاحية للوصول إلى لوحة التحكم');
          logout();
          return false;
        }
        document.getElementById('userName').textContent = currentUser.name || currentUser.phone;
      } catch (error) {
        logout();
        return false;
      }

      return true;
    }

    function logout() {
      localStorage.removeItem('admin_token');
      localStorage.removeItem('admin_user');
      window.location.href = 'login.html';
    }

    function getAuthHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      };
    }

    // Load dashboard stats
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/stats`, {
          headers: getAuthHeaders()
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();
        const stats = data.stats;

        document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
        document.getElementById('totalVenues').textContent = stats.totalVenues || 0;
        document.getElementById('totalServices').textContent = stats.totalServices || 0;
        document.getElementById('totalBookings').textContent = stats.totalBookings || 0;
        document.getElementById('totalRevenue').textContent = (stats.totalRevenue || 0).toFixed(2) + ' د.ك';
        document.getElementById('pendingBookings').textContent = stats.pendingBookings || 0;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Tab switching
    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Section').classList.add('active');
      
      if (tabName === 'users') loadUsers();
      else if (tabName === 'venues') loadVenues();
      else if (tabName === 'services') loadServices();
      else if (tabName === 'bookings') loadBookings();
    }

    // Load users
    async function loadUsers() {
      const search = document.getElementById('userSearch').value;
      const tableDiv = document.getElementById('usersTable');
      tableDiv.innerHTML = '<div class="loading">جاري التحميل...</div>';

      try {
        const url = `${API_BASE_URL}/admin/users?search=${encodeURIComponent(search)}`;
        const response = await fetch(url, {
          headers: getAuthHeaders()
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();

        if (data.users.length === 0) {
          tableDiv.innerHTML = '<div class="empty-state">لا توجد نتائج</div>';
          return;
        }

        let html = '<table><thead><tr><th>الاسم</th><th>البريد</th><th>الهاتف</th><th>الدور</th><th>الموقع</th><th>الحالة</th><th>تاريخ الإنشاء</th><th>الإجراءات</th></tr></thead><tbody>';
        
        data.users.forEach(user => {
          const roleClass = user.role.toLowerCase();
          html += `<tr>
            <td>${user.name || '-'}</td>
            <td>${user.email || '-'}</td>
            <td>${user.phone || '-'}</td>
            <td><span class="badge ${roleClass}">${user.role}</span></td>
            <td>${user.location || '-'}</td>
            <td><span class="badge ${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'نشط' : 'معطل'}</span></td>
            <td>${new Date(user.createdAt).toLocaleDateString('ar-EG')}</td>
            <td>
              <button class="btn btn-edit" onclick="editUser('${user.id}')">تعديل</button>
              ${user.id !== currentUser.id ? `<button class="btn btn-delete" onclick="deleteUser('${user.id}')">حذف</button>` : ''}
            </td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
      } catch (error) {
        tableDiv.innerHTML = '<div class="error">خطأ في تحميل البيانات</div>';
        console.error('Error loading users:', error);
      }
    }

    // Load venues
    async function loadVenues() {
      const search = document.getElementById('venueSearch').value;
      const tableDiv = document.getElementById('venuesTable');
      tableDiv.innerHTML = '<div class="loading">جاري التحميل...</div>';

      try {
        const url = `${API_BASE_URL}/admin/venues?search=${encodeURIComponent(search)}`;
        const response = await fetch(url, {
          headers: getAuthHeaders()
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();

        if (data.venues.length === 0) {
          tableDiv.innerHTML = '<div class="empty-state">لا توجد نتائج</div>';
          return;
        }

        let html = '<table><thead><tr><th>الاسم</th><th>المزود</th><th>السعر</th><th>التقييم</th><th>الحالة</th><th>الإجراءات</th></tr></thead><tbody>';
        
        data.venues.forEach(venue => {
          const statusClass = venue.isActive ? 'active' : 'inactive';
          html += `<tr>
            <td>${venue.nameAr || venue.name}</td>
            <td>${venue.provider?.name || '-'}</td>
            <td>${venue.price} د.ك</td>
            <td>${venue.rating || 0} (${venue.reviewCount || 0})</td>
            <td><span class="badge ${statusClass}">${venue.isActive ? 'نشط' : 'غير نشط'}</span></td>
            <td>
              <button class="btn btn-toggle" onclick="toggleVenueStatus('${venue.id}', ${!venue.isActive})">
                ${venue.isActive ? 'تعطيل' : 'تفعيل'}
              </button>
              <button class="btn btn-delete" onclick="deleteVenue('${venue.id}')">حذف</button>
            </td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
      } catch (error) {
        tableDiv.innerHTML = '<div class="error">خطأ في تحميل البيانات</div>';
        console.error('Error loading venues:', error);
      }
    }

    // Load services
    async function loadServices() {
      const search = document.getElementById('serviceSearch').value;
      const tableDiv = document.getElementById('servicesTable');
      tableDiv.innerHTML = '<div class="loading">جاري التحميل...</div>';

      try {
        const url = `${API_BASE_URL}/admin/services?search=${encodeURIComponent(search)}`;
        const response = await fetch(url, {
          headers: getAuthHeaders()
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();

        if (data.services.length === 0) {
          tableDiv.innerHTML = '<div class="empty-state">لا توجد نتائج</div>';
          return;
        }

        let html = '<table><thead><tr><th>الاسم</th><th>الفئة</th><th>المزود</th><th>السعر</th><th>التقييم</th><th>الحالة</th><th>الإجراءات</th></tr></thead><tbody>';
        
        data.services.forEach(service => {
          const statusClass = service.isActive ? 'active' : 'inactive';
          html += `<tr>
            <td>${service.nameAr || service.name}</td>
            <td>${service.category?.nameAr || service.category?.name || '-'}</td>
            <td>${service.provider?.name || '-'}</td>
            <td>${service.price} د.ك</td>
            <td>${service.rating || 0} (${service.reviewCount || 0})</td>
            <td><span class="badge ${statusClass}">${service.isActive ? 'نشط' : 'غير نشط'}</span></td>
            <td>
              <button class="btn btn-toggle" onclick="toggleServiceStatus('${service.id}', ${!service.isActive})">
                ${service.isActive ? 'تعطيل' : 'تفعيل'}
              </button>
              <button class="btn btn-delete" onclick="deleteService('${service.id}')">حذف</button>
            </td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
      } catch (error) {
        tableDiv.innerHTML = '<div class="error">خطأ في تحميل البيانات</div>';
        console.error('Error loading services:', error);
      }
    }

    // Load bookings
    async function loadBookings() {
      const search = document.getElementById('bookingSearch').value;
      const tableDiv = document.getElementById('bookingsTable');
      tableDiv.innerHTML = '<div class="loading">جاري التحميل...</div>';

      try {
        const url = `${API_BASE_URL}/admin/bookings?search=${encodeURIComponent(search)}`;
        const response = await fetch(url, {
          headers: getAuthHeaders()
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();

        if (data.bookings.length === 0) {
          tableDiv.innerHTML = '<div class="empty-state">لا توجد نتائج</div>';
          return;
        }

        let html = '<table><thead><tr><th>رقم الحجز</th><th>العميل</th><th>القاعة</th><th>التاريخ</th><th>المبلغ</th><th>الحالة</th><th>الإجراءات</th></tr></thead><tbody>';
        
        data.bookings.forEach(booking => {
          const statusClass = booking.status.toLowerCase();
          html += `<tr>
            <td>${booking.bookingNumber}</td>
            <td>${booking.customer?.name || '-'}</td>
            <td>${booking.venue?.nameAr || booking.venue?.name || '-'}</td>
            <td>${new Date(booking.date).toLocaleDateString('ar-EG')}</td>
            <td>${booking.finalAmount} د.ك</td>
            <td><span class="badge ${statusClass}">${booking.status}</span></td>
            <td>
              <button class="btn btn-edit" onclick="updateBookingStatus('${booking.id}', 'CONFIRMED')">تأكيد</button>
              <button class="btn btn-delete" onclick="updateBookingStatus('${booking.id}', 'CANCELLED')">إلغاء</button>
            </td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        tableDiv.innerHTML = html;
      } catch (error) {
        tableDiv.innerHTML = '<div class="error">خطأ في تحميل البيانات</div>';
        console.error('Error loading bookings:', error);
      }
    }

    // Toggle venue status
    async function toggleVenueStatus(id, isActive) {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/venues/${id}/status`, {
          method: 'PATCH',
          headers: getAuthHeaders(),
          body: JSON.stringify({ isActive })
        });

        if (response.status === 401) {
          logout();
          return;
        }

        if (response.ok) {
          loadVenues();
          loadStats();
        }
      } catch (error) {
        console.error('Error toggling venue status:', error);
        alert('حدث خطأ أثناء تحديث الحالة');
      }
    }

    // Toggle service status
    async function toggleServiceStatus(id, isActive) {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/services/${id}/status`, {
          method: 'PATCH',
          headers: getAuthHeaders(),
          body: JSON.stringify({ isActive })
        });

        if (response.status === 401) {
          logout();
          return;
        }

        if (response.ok) {
          loadServices();
          loadStats();
        }
      } catch (error) {
        console.error('Error toggling service status:', error);
        alert('حدث خطأ أثناء تحديث الحالة');
      }
    }

    // Delete venue
    async function deleteVenue(id) {
      if (!confirm('هل أنت متأكد من حذف هذه القاعة؟')) return;
      try {
        const response = await fetch(`${API_BASE_URL}/admin/venues/${id}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (response.status === 401) {
          logout();
          return;
        }

        if (response.ok) {
          loadVenues();
          loadStats();
        } else {
          const data = await response.json();
          alert(data.error || 'حدث خطأ أثناء الحذف');
        }
      } catch (error) {
        console.error('Error deleting venue:', error);
        alert('حدث خطأ أثناء الحذف');
      }
    }

    // Delete service
    async function deleteService(id) {
      if (!confirm('هل أنت متأكد من حذف هذه الخدمة؟')) return;
      try {
        const response = await fetch(`${API_BASE_URL}/admin/services/${id}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (response.status === 401) {
          logout();
          return;
        }

        if (response.ok) {
          loadServices();
          loadStats();
        } else {
          const data = await response.json();
          alert(data.error || 'حدث خطأ أثناء الحذف');
        }
      } catch (error) {
        console.error('Error deleting service:', error);
        alert('حدث خطأ أثناء الحذف');
      }
    }

    // Update booking status
    async function updateBookingStatus(id, status) {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/bookings/${id}/status`, {
          method: 'PATCH',
          headers: getAuthHeaders(),
          body: JSON.stringify({ status })
        });

        if (response.status === 401) {
          logout();
          return;
        }

        if (response.ok) {
          loadBookings();
          loadStats();
        } else {
          const data = await response.json();
          alert(data.error || 'حدث خطأ أثناء التحديث');
        }
      } catch (error) {
        console.error('Error updating booking status:', error);
        alert('حدث خطأ أثناء التحديث');
      }
    }

    // Edit user
    function editUser(id) {
      alert('ميزة التعديل قيد التطوير');
    }

    // Delete user
    async function deleteUser(id) {
      if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟')) return;
      try {
        const response = await fetch(`${API_BASE_URL}/admin/users/${id}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (response.status === 401) {
          logout();
          return;
        }

        if (response.ok) {
          loadUsers();
          loadStats();
        } else {
          const data = await response.json();
          alert(data.error || 'حدث خطأ أثناء الحذف');
        }
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('حدث خطأ أثناء الحذف');
      }
    }

    // Initialize
    if (checkAuth()) {
      loadStats();
      loadUsers();
    }
  </script>
</body>
</html>



